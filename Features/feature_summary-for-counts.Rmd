---
title: "Features Summary"
author: "Javad Khataei"
date: "9/04/2019"
output:
    html_document:
        code_folding : hide
        toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

In this markdown, we use **x, y, z Counts** variables to created new features and then we have a look at the **Mean** and **Standard devation** of the features. 

## Generating Features

### Read and prepare the data
```{r message=FALSE, warning=FALSE}


#import libraries
library(data.table)
library(tidyverse)
library(lubridate)
library(activityCounts)
library(magrittr)
library(scales)
library(caret)
library(stringr)
library(MLmetrics)
library(PRROC)
library(gridExtra)
library(kableExtra)
library(imputeTS)
library(Beap) # It's not on CRAN yet





# ---------------------------- Read the data ----------------------

# set the working directory to the folder that has the raw data and the intervals file
OS <- Sys.info()
if (OS["sysname"] == "Windows") {
  main_path <-
    "Z:/Research/dfuller/Walkabilly/studies/smarphone_accel/data"
} else {
  main_path <-
    "/Volumes/hkr-storage/Research/dfuller/Walkabilly/studies/smarphone_accel/data"
}

# Read the file with x,y,z axis and labels.
Ethica_df <-
  fread(paste0(main_path,"/Ethica_Jaeger_Merged/pocket/pocket_with_couns_and_vec_meg_not_duplicated.csv"))


# ---------------------------- Prepare the data ----------------------------

# Participants 112 , 121 .122 , and 132 are not properly classified
working_df  <-
  Ethica_df %>% filter(!(participant_id %in% c(112, 121, 122, 132)))

# Model A_1 only uses raw accel data
working_df %<>%  dplyr::select(c(x, y, z, counts_vec_mag, participant_id, trimmed_activity))
working_df  %<>% filter(trimmed_activity != "transit")


# models canot work with strin
working_df$trimmed_activity  %<>% str_replace_all(" ", "_") %>%
  factor(
    levels = c(
      "Lying",
      "Sitting",
      "Self_Pace_walk",
      "Running_3_METs",
      "Running_5_METs",
      "Running_7_METs"
    )
  )

# # each 10 observation has one counts so reduce from 10Hz to 1Hz
frequency <- 10
working_df  %<>% groupdata2::group(n = frequency, method = "greedy") %>%
  rename( "id" = .groups )
working_df  %<>% group_by(id) %>%
  summarise_all(first) %>%
  select(-id)

```

Note that we need to exclude Participants number 112 , 121 .122 , and 132 as they are not properly classified. Also, to save time, we run the models on  some of the data. Check the code for more details.



### Generate new features
We use the function ``GenerateFeatures` from the `Beap` package to create new features for `x`, `y`, and `z` counts. Then we apply the models. The window is set to 2 seconds. The Counts frequency is 1 Hz.


```{r message= T , warning=FALSE}
frequency <- 1 # freq of new data which is counts not raw x,y,z axis
window_size_sec <- 2
# The number of features reduces by this
reduction_coef <-  window_size_sec * frequency
new_features_df <-
  GenerateFeatures(raw_df = working_df,
                   window_size_sec = window_size_sec,
                   frequency = frequency) 
# Increase the frequency
new_features_df <-
  new_features_df[rep(1:nrow(new_features_df) , each = reduction_coef),]


# reduce the size of working_df to add new_features
working_df  %<>% slice(1:nrow(new_features_df))

working_df <- bind_cols(working_df, new_features_df)
# some models cannpt train if there is any NA
working_df  %<>% na_interpolation(option =  "linear")


```





## Calculated Mean for each participant

```{r message=FALSE, warning=FALSE}

working_df %>% group_by(participant_id) %>% 
        select(-c(trimmed_activity)) %>% 
    summarise_all(mean) %>%  
    kable(label = " Features SD for each participant") %>%
    kable_styling(full_width = T, bootstrap_options = c("striped", "hover", "responsive")) %>% 
    scroll_box(width = "100%", height = "600px")
 
```

## Calculated Mean for all 

```{r message=FALSE, warning=FALSE}
working_df %>% 
    select(-c(participant_id, trimmed_activity)) %>% 
    summarise_all(mean) %>%  
    kable(label = " Features mean for all participant") %>%
    kable_styling(full_width = T, bootstrap_options = c("striped", "hover", "responsive")) 
 
```




## Calculated SD for each participant 

```{r message=FALSE, warning=FALSE}
working_df %>% group_by(participant_id) %>% 
        select(-c(trimmed_activity)) %>% 
    summarise_all(sd) %>%  
    kable(label = " Features SD for each participant") %>%
    kable_styling(full_width = T, bootstrap_options = c("striped", "hover", "responsive")) %>% 
    scroll_box(width = "100%", height = "600px")
 
```

As it is shown above, nine features, do not have any standard deviation, meaning they are constant. We confirm this by calcutaing SD for all the participants. 



## Calculated SD for all 

```{r message=FALSE, warning=FALSE}
working_df %>% 
        select(-c(participant_id,trimmed_activity)) %>% 
    summarise_all(sd) %>%  
    kable(label = " Features SD for al participant") %>%
    kable_styling(full_width = T, bootstrap_options = c("striped", "hover", "responsive")) 
 
```

We need to eliminate these features in final Case 4 as they don't carry any usable information.


# Plot Mean 
```{r}
working_df %>% 
  select(-c(participant_id,trimmed_activity)) %>% 
  select(1:5) %>% 
  stack() %>% 
  ggplot(aes(x = ind, y = values)) +
  geom_violin(scale = "width") +
  geom_boxplot(width=0.1)


working_df %>% 
  select(-c(participant_id,trimmed_activity)) %>% 
  select(6:10) %>% 
  stack() %>% 
  ggplot(aes(x = ind, y = values)) +
  geom_violin(scale = "width") +
  geom_boxplot(width=0.1)

working_df %>% 
  select(-c(participant_id,trimmed_activity)) %>% 
  select(11:15) %>% 
  stack() %>% 
  ggplot(aes(x = ind, y = values)) +
  geom_violin(scale = "width") +
  geom_boxplot(width=0.1)

working_df %>% 
  select(-c(participant_id,trimmed_activity)) %>% 
  select(16:20) %>% 
  stack() %>% 
  ggplot(aes(x = ind, y = values)) +
  geom_violin(scale = "width") +
  geom_boxplot(width=0.1)

working_df %>% 
  select(-c(participant_id,trimmed_activity)) %>% 
  select(21:25) %>% 
  stack() %>% 
  ggplot(aes(x = ind, y = values)) +
  geom_violin(scale = "width") +
  geom_boxplot(width=0.1)

working_df %>% 
  select(-c(participant_id,trimmed_activity)) %>% 
  select(26:30) %>% 
  stack() %>% 
  ggplot(aes(x = ind, y = values)) +
  geom_violin(scale = "width") +
  geom_boxplot(width=0.1)

working_df %>% 
  select(-c(participant_id,trimmed_activity)) %>% 
  select(31:35) %>% 
  stack() %>% 
  ggplot(aes(x = ind, y = values)) +
  geom_violin(scale = "width") +
  geom_boxplot(width=0.1)


working_df %>% 
  select(-c(participant_id,trimmed_activity)) %>% 
  select(36:40) %>% 
  stack() %>% 
  ggplot(aes(x = ind, y = values)) +
  geom_violin(scale = "width") +
  geom_boxplot(width=0.1)

working_df %>% 
  select(-c(participant_id,trimmed_activity)) %>% 
  select(41:45) %>% 
  stack() %>% 
  ggplot(aes(x = ind, y = values)) +
  geom_violin(scale = "width") +
  geom_boxplot(width=0.1)

working_df %>% 
  select(-c(participant_id,trimmed_activity)) %>% 
  select(46:50) %>% 
  stack() %>% 
  ggplot(aes(x = ind, y = values)) +
  geom_violin(scale = "width") +
  geom_boxplot(width=0.1)

working_df %>% 
  select(-c(participant_id,trimmed_activity)) %>% 
  select(51:55) %>% 
  stack() %>% 
  ggplot(aes(x = ind, y = values)) +
  geom_violin(scale = "width") +
  geom_boxplot(width=0.1)

working_df %>% 
  select(-c(participant_id,trimmed_activity)) %>% 
  select(56:59) %>% 
  stack() %>% 
  ggplot(aes(x = ind, y = values)) +
  geom_violin(scale = "width") +
  geom_boxplot(width=0.1)



```
```{r eval=FALSE, include=FALSE}

size <- nrow(working_df) * 5 # plotting 5 variables in each graph

working_df %>% 
  select(-c(participant_id,trimmed_activity)) %>% 
  stack() %>% groupdata2::group(n = size, method = "greedy") %>%
  rename("id" = .groups) %>%  group_by(id) %>% 
  ggplot(aes(x = ind, y = values)) +
  geom_violin(scale = "width") +
  geom_boxplot(width=0.1)

```




# Plot Mean for all
```{r}
new_features_df %>% 
  summarise_all(mean) %>% 
  stack() %>% 
  ggplot(aes(x = ind, y = values)) +
  geom_violin() +
  geom_boxplot(width=0.1)

```


```{r}
Mean_SD <- function(x) { # a function to calculate mean and SD and return them together
  paste0(round(mean(x),digits = 2)," (", round(sd(x), digits = 2),")")
}

mean_sd_all_df <- working_df %>% 
    select(-c(  participant_id, trimmed_activity)) %>% 
    summarise_all(Mean_SD) %>%
  data.table::transpose() 

colnames(mean_sd_all_df) <- "Grand Mean (SD)"

table_df <- working_df %>% group_by(trimmed_activity) %>% 
    select(-c(  participant_id)) %>% 
    summarise_all(Mean_SD)

col_names <- table_df$trimmed_activity %>% as.character()
col_names <- paste0(col_names," Mean (SD)")
table_df %<>% select(-trimmed_activity)
row_names <- colnames(table_df)

table_df %<>% data.table::transpose()
rownames(table_df) <- row_names
colnames(table_df) <- col_names

table_df <- cbind(mean_sd_all_df,table_df)


table_df %>%  
    kable(label = " Features mean and SD based on Activity") %>%
    kable_styling(full_width = T, bootstrap_options = c("striped", "hover", "responsive"))

```


```

